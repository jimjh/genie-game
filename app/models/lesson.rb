# == Lesson
# A lesson record in the database _should_ correspond to a lesson directory in
# the filesystem, although for performance reasons that's not enforced.
#
# - +slug+ is generated by friendly_id from +name+.
# - +name+ is the repositories identifier on the provider. It can be any string
#   value, although the controllers (with knowledge of GitHub's conventions)
#   might set this to the repository's name for easier web hooking. This is not
#   validated, because the model should be provider-independent. It defaults to
#   +basename url+.
# - +url+ is a cloneable url of the git repository.
# - +hook+ is the ID of a web hook registered with the provider.
# - +status+ is either
#   - +publishing+,
#   - +published+, or
#   - +failed+
#
# TODO faye
class Lesson < ActiveRecord::Base
  extend FriendlyId
  include GitConcern

  STATUSES = %w[publishing published failed]

  # callbacks ----------------------------------------------------------------
  before_validation :default_values

  # attributes ---------------------------------------------------------------
  friendly_id       :name, use: :scoped, scope: [:user]
  attr_accessible   :name, :url
  attr_accessor     :action

  # relationships ------------------------------------------------------------
  belongs_to :user

  # validations --------------------------------------------------------------
  validates_presence_of   :name, :url, :user_id
  validates_uniqueness_of :name, scope: :user_id
  validates_inclusion_of  :status, in: STATUSES
  validates_existence_of  :user
  validate                :url_must_be_valid

  # scopes -------------------------------------------------------------------
  scope :published, where(status: 'published')

  # @return [Pathname] path that is suitable for use as lesson path
  def path
    Pathname.new(user.slug) + self.slug
  end

  def failed
    self.status = 'failed'
    save!
    notify_observers :after_fail
  end

  def published(opts)
    self.compiled_path = opts[:compiled_path]
    self.solution_path = opts[:solution_path]
    self.status = 'published'
    save!
    notify_observers :after_publish
  end

  def pushed
    self.status = 'publishing'
    save!
    notify_observers :after_push
  end

  private

  # Checks if the given url is a valid git URL. Local paths with +file://+ are
  # not supported.
  # @note This is not foolproof, and a hacker and still supply a carefully
  #   crafted string to trick us into cloning a local repository.
  # @see http://www.kernel.org/pub/software/scm/git/docs/git-clone.html
  def url_must_be_valid
    url.blank? ||
      (url_is_remote? and url_has_suffix? and url_matches?) ||
      errors.add(:url, 'is not a valid git URL.')
  end

  # Sets default values.
  def default_values
    self.name ||= File.basename(url || '', GitConcern::GIT_SUFFIX)
  end

end
